# Алгоритм LVN !heading

### Команда Roll

#### Постановка задачи
Найти избыточные выражения в базовом блоке и заменить их на ранее вычисленное значение. Применить алгоритм LVN.

#### Зависимости задач в графе задач

Задача зависит от:
* Генерация трехадресного кода
* Выделение базовых блоков

#### Теория
Алгоритм LVN (LVA) ставит в соответствие каждому вычисляемому значению номер. Для каждой из бинарных операций трехадресного кода из строкового представления операции и номеров значений формируется ключ в словаре. Если новый ключ уже есть в словаре, то операция заменяется копией значения из словаря. Иначе в словарь добавляется новое значение с новым сгенерированным номером-ключом.

#### Особенности реализации
Для использования данной оптимизации необходимо:
1. Подключить пространство имен using SimpleLang.ThreeCodeOptimisations;
2. Построить граф потоков управления
3. Применить оптимизацию к каждому из блоков либо ко всему графу

Ниже представлен код использования данной оптимизации:
```csharp
// граф потоков управления controlFlowGraph уже построен
foreach (var block in controlFlowGraph.blocks)
{
	var replace = LVNOptimization.LVNOptimize(block);
	block.Clear();
	foreach (var line in replace)
		block.AddLast(line);
}

```
Так как метод LVNOptimize не изменяет исходный блок, а возвращает новый, то каждый блок исходного графа нужно заменять на оптимизированный. Для упрощения выполнения данной оптимизации в классе DeadOrAliveOptimization реализован метод, который выполняет эту оптимизацию для всего переданного графа и возвращает новый граф:
```csharp
controlFlowGraph = LVNOptimization.LVNOptimize(controlFlowGraph);
```

#### Тесты
``` csharp
Исходный код
{
    var a,b,c,d,x,y;
    a = (x + y);
    b = (x + y);
    a = (17 * 32);
    b = (17 * 32);
    c = (a + b);
    x = (a + b);
    y = (17 * 32);
    for (d = 2 to 5)
    {
        c = (a + b);
        y = (17 * 32);
        x = (a + b);
    }
}
Блоки трехадресного кода до оптимизации
           a = x + y
           b = x + y
           a = 17 * 32
           b = 17 * 32
           c = a + b
           x = a + b
           y = 17 * 32
           d = 2
label_0:   temp_0 = d < 5
           if temp_0 goto label_1
           goto label_2
label_1:   c = a + b
           y = 17 * 32
           x = a + b
           d = d + 1
           goto label_0
label_2:


После применения LVN
           a = x + y
           b = a
           a = 17 * 32
           b = a
           c = a + b
           x = c
           y = b
           d = 2
label_0:   temp_0 = d < 5
           if temp_0 goto label_1
           goto label_2
label_1:   c = a + b
           y = 17 * 32
           x = c
           d = d + 1
           goto label_0
label_2:
```

[Вверх](#содержание)